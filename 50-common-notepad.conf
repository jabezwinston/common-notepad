# /etc/apache2/sites-available/000-default.conf
# Or create a new site configuration file

<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    # Enable required modules
    # Make sure these are enabled: a2enmod proxy proxy_http proxy_wstunnel rewrite headers

    # Reverse proxy for the Common_Notepad application
    ProxyPreserveHost On
    
    # Handle WebSocket connections for Socket.IO
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/Common_Notepad/socket.io/(.*) ws://127.0.0.1:3000/socket.io/$1 [P,L]

    # Handle Socket.IO polling and regular HTTP requests
    ProxyPass /Common_Notepad/socket.io/ http://127.0.0.1:3000/socket.io/
    ProxyPassReverse /Common_Notepad/socket.io/ http://127.0.0.1:3000/socket.io/

    # Handle login API
    ProxyPass /Common_Notepad/login http://127.0.0.1:3000/login
    ProxyPassReverse /Common_Notepad/login http://127.0.0.1:3000/login

    # Handle main application
    ProxyPass /Common_Notepad/ http://127.0.0.1:3000/
    ProxyPassReverse /Common_Notepad/ http://127.0.0.1:3000/

    # Set headers for WebSocket support
    ProxyPass /Common_Notepad http://127.0.0.1:3000/Common_Notepad
    ProxyPassReverse /Common_Notepad http://127.0.0.1:3000/Common_Notepad

    # Optional: Add headers for better WebSocket support
    <Location "/Common_Notepad">
        ProxyPassReverse /
        ProxyPassReverseMap / /Common_Notepad/
        Header always set X-Forwarded-Proto "http"
        Header always set X-Forwarded-Port "80"
    </Location>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
